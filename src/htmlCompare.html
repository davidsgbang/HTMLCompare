<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"> 
		<script src="http://code.jquery.com/jquery-1.10.2.min.js" type="text/javascript"></script>
		<script>

			var frameOneHash = {};
			var frameTwoHash = {};
			var frameOneProcessed = false;

			function DOMelement (element) {

				this.originalElement = element;
				this.tagName = element.tagName;
				this.content = element.innerHTML;
				this.value = element.textContent.replace(/\n|\t/gm, "");
				this.posLeft = element.offsetLeft;
				this.posTop = element.offsetTop;
				this.children = element.children;
				this.parent = element.parentNode;
				this.attributes = element.attributes;
				this.style = element.style;
				this.toString = element.tagName + " : " + this.posLeft + ", " + this.posTop;
				this.width = element.style.width;
				this.height = element.style.height;

			}

			function checkSubmitForm(form) {

				var frameOne = $("#frameOne");
				frameOne.attr({src : 'Examples/'+form.fileOne.value});
			
				var frameTwo = $("#frameTwo");
				frameTwo.attr({src : 'Examples/'+form.fileTwo.value});
				
				setTimeout(function() {
					traverseDOM(frameOne.contents().find("body").get(0));
					frameOneProcessed = true;
					traverseDOM(frameTwo.contents().find("body").get(0));

					frameOne.attr({src : 'Examples/'+form.fileOne.value});
					frameTwo.attr({src : 'Examples/'+form.fileTwo.value});


					compareHashes();



				}, 500);


			
			}

			function traverseDOM(paramElement) {
				
				// First, go through all the children, look at all the element, 
				// then recursively call traverseDOM on each child
				// lastly, remove the child, so we can get the inner text without children's text appearing
				var childrenList = paramElement.children;
				for (var i = childrenList.length-1; i >= 0; i--) {
					traverseDOM(childrenList[i]);
					paramElement.removeChild(childrenList[i]);
				}

				// then make the DOM object ONLY if this DOM element has a text content
				if (paramElement.textContent.replace(/\n|\t/gm, "") != "") {
					
					var element = new DOMelement(paramElement);

					// if we find an ID, then assign the key in the hash to be an ID
					// else, use [tagName]_[left]_[top] format key
					if ((id = element.attributes.getNamedItem("id")) != null) {
						if (frameOneProcessed) {
						//	frameTwoHash[id.nodeValue] = element.value.replace(/\n|\t/gm, "");
							frameTwoHash[id.nodeValue] = element;
						} else {
							frameOneHash[id.nodeValue] = element;	
						}
						
					} else {
						hashIndex = element.tagName + "_" + element.posLeft + "_" + element.posTop;
						if (frameOneProcessed) {
						//	frameTwoHash[hashIndex] = element.value.replace(/\n|\t/gm, "");
							frameTwoHash[hashIndex] = element;
						} else {
							frameOneHash[hashIndex] = element;
						}
						

						
					}
				}
				
			}

			/* from stackoverflow
			by Blender
			http://stackoverflow.com/a/16227231
			*/


			function intersection(array1, array2) {
				var results = new Array();

				for (var index = 0; index < array1.length; index++) {
					if (array2.indexOf(array1[index]) !== -1) {
						results.push(array1[index]);
					}
				}
				var avgArrayLength = (array1.length + array2.length) /2 ;

				return ((results.length / avgArrayLength) * 100);
			}

			function compareHashes() {

				for (var hashOneIndex = 0; hashOneIndex < Object.keys(frameOneHash).length; hashOneIndex++) {
					var keyToCompare = Object.keys(frameOneHash)[hashOneIndex];
					if (frameTwoHash[keyToCompare] != null) {
						compareDOMelements(frameOneHash[keyToCompare], frameTwoHash[keyToCompare]);
					} else {
						for (var hashTwoIndex = 0; hashTwoIndex < Object.keys(frameTwoHash).length; hashTwoIndex++) {					
							compareDOMelements(frameOneHash[keyToCompare], frameTwoHash[Object.keys(frameTwoHash)[hashTwoIndex]]);
						}
					}

				}

			}

			function compareDOMelements(element1, element2) {
				// word based intersection. Normal "split" doesn't remove puncutations!
				var element1ValueArr = element1.value.toLowerCase().replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(" ");
				var element2ValueArr = element2.value.toLowerCase().replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(" ");

				// compareContent == percentage for postion diff
				var compareContent = intersection(element1ValueArr, element2ValueArr);
				var diffWidth = Math.abs(element1.posLeft - element2.posLeft);
				var diffHeight = Math.abs(element1.posTop - element2.posTop);

				// compare the width and height differential by percentage based on the size of the entire body
				var compareWidth = ((diffWidth / document.body.clientWidth) * 100);
				var compareHeight = ((diffHeight / document.body.clientHeight) * 100);

				compareDOMstyles(element1, element2);

			}

			function compareDOMstyles(element1, element2) {
				var style2 = document.defaultView.getComputedStyle(element1.originalElement,null).getPropertyValue('color');
				alert(element1.originalElement.innerHTML);
				alert(style2);

			}



		</script>
	</head>
	<body>

		<iframe id="frameOne">
		</iframe>

		<iframe id="frameTwo">
		</iframe>

		<div id="content">

		</div>

		<form id="compareFileForm" onsubmit="checkSubmitForm(this); return false;">
			<input name="fileOne" type="file" />
			<input name="fileTwo" type="file" />
			<input type="submit" />
		</form>

	</body>
</html>
